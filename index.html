<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body { background:#f8f9fa; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
        .container-max { max-width: 920px; }
        .item-row { display: flex; gap: .5rem; align-items:center; flex-wrap:wrap;
            margin-bottom: 12px; }
        .item-name { flex: 1 1 180px; min-width: 140px; }
        .item-amount { width: 140px; max-width: 40%; min-width:110px; }
        @media (max-width: 480px) {
            .item-amount { width: 100%; max-width: none; }
            .item-row { gap: .6rem; }
        }
        .small-muted { color: #6c757d; font-size:.9rem; }
        /* Result card inner spacing */
        #result .list-group-item { display:flex; justify-content:space-between; gap:.5rem; align-items:center; }
    </style>
</head>
<body>
<div class="container container-max py-4">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h2 class="h4 mb-0">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h2>
            <div class="small-muted">–ß—ë—Ç–∫–æ, –ø—Ä–æ—Å—Ç–æ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π</div>
        </div>
        <div class="text-end">
            <button id="clearAll" class="btn btn-outline-secondary btn-sm" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">
                <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h6 mb-0">–î–æ—Ö–æ–¥—ã</h3>
                        <button id="addIncome" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                    <div id="income-list" class="mb-2"></div>
                    <div class="small-muted">–ö–∞–∂–¥—ã–π –¥–æ—Ö–æ–¥ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π</div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h6 mb-0">–†–∞—Å—Ö–æ–¥—ã</h3>
                        <button id="addExpense" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                    <div id="expenses-list" class="mb-2"></div>
                    <div class="small-muted">–í–∫–ª—é—á–∞–π –≤—Å—ë: –ø–æ–¥–ø–∏—Å–∫–∏, –µ–¥–∞, –±–µ–Ω–∑–∏–Ω</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3 mb-3 shadow-sm">
        <div class="card-body">
            <h3 class="h6">–ü–µ—Ä–∏–æ–¥ –±—é–¥–∂–µ—Ç–∞</h3>
            <div class="row g-2">
                <div class="col-12 col-sm-6">
                    <label class="form-label small">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                    <input id="start-date" type="date" class="form-control form-control-sm">
                </div>
                <div class="col-12 col-sm-6">
                    <label class="form-label small">–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞</label>
                    <input id="end-date" type="date" class="form-control form-control-sm">
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid mb-2">
        <button id="calculateBtn" class="btn btn-success btn-lg">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
    </div>

    <div id="result" class="card d-none shadow-sm">
        <div class="card-body" id="result-body"></div>
    </div>
</div>

<!-- Script -->
<script>
    const $ = sel => document.querySelector(sel);
    const fmt = n => Number(n).toLocaleString('ru-RU', {maximumFractionDigits: 2, minimumFractionDigits: (Number(n)%1 ? 2 : 0)});
    const msPerDay = 1000 * 60 * 60 * 24;

    // --- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–æ—Ö–æ–¥–∞/—Ä–∞—Å—Ö–æ–¥–∞ ---
    function addInput(listId, name = '', value = '', transferred = false) {
        const container = document.getElementById(listId);
        const row = document.createElement('div');
        row.className = 'item-row';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'form-control form-control-sm item-name';
        nameInput.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ó–∞—Ä–ø–ª–∞—Ç–∞, –§—Ä–∏–ª–∞–Ω—Å...)';
        nameInput.value = name || '';

        const amountInput = document.createElement('input');
        amountInput.type = 'number';
        amountInput.step = '0.01';
        amountInput.className = 'form-control form-control-sm item-amount';
        amountInput.placeholder = '–°—É–º–º–∞';
        amountInput.value = (value !== undefined && value !== null) ? value : '';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-danger btn-sm';
        btn.title = '–£–¥–∞–ª–∏—Ç—å';
        btn.innerHTML = '<i class="bi bi-x-lg"></i>';
        btn.addEventListener('click', () => {
            row.remove();
            saveData();
        });

        // --- –ß–µ–∫–±–æ–∫—Å –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ ---
        let checkbox = null;
        if (listId === 'expenses-list') {
            checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input me-2';
            checkbox.title = '–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç';
            checkbox.checked = transferred;
            checkbox.addEventListener('change', saveData);
        }

        [nameInput, amountInput].forEach(inp => inp.addEventListener('input', saveData));

        if (checkbox) row.appendChild(checkbox);
        row.append(nameInput, amountInput, btn);
        container.appendChild(row);
        if (!name && !value) nameInput.focus();
        saveData();
    }

    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π ---
    function getItems(listId) {
        const rows = document.querySelectorAll(`#${listId} .item-row`);
        return Array.from(rows).map(row => {
            const name = row.querySelector('.item-name').value.trim();
            const raw = row.querySelector('.item-amount').value;
            const v = parseFloat(String(raw).replace(',', '.')) || 0;
            const checkbox = row.querySelector('input[type="checkbox"]');
            const transferred = checkbox ? checkbox.checked : false;
            return { name, value: v, transferred };
        });
    }

    function sum(items) {
        return items.reduce((s, it) => s + Number(it.value || 0), 0);
    }

    // --- –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ---
    function calculate() {
        const incomes = getItems('income-list');
        const expenses = getItems('expenses-list');

        const income = sum(incomes);
        const expense = sum(expenses.filter(e => !e.transferred)); // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ
        const balance = income - expense;
        const savingsRate = income > 0 ? ((balance / income) * 100) : 0;

        const startVal = $('#start-date').value;
        const endVal = $('#end-date').value;
        let days = 0, perDay = 0;
        if (startVal && endVal) {
            const start = new Date(startVal);
            const end = new Date(endVal);
            days = Math.ceil((end - start) / msPerDay) + 1;
            if (days < 0) days = 0;
            if (days > 0 && balance > 0) perDay = balance / days;
        }

        const resultBody = $('#result-body');
        resultBody.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'd-flex justify-content-between align-items-start mb-3';
        header.innerHTML = `
        <div>
          <h5 class="mb-1">–ë–∞–ª–∞–Ω—Å: <span class="${balance>0 ? 'text-success' : (balance<0 ? 'text-danger' : 'text-muted')}">${fmt(balance)} ‚ÇΩ</span></h5>
          <div class="small-muted">–î–æ—Ö–æ–¥—ã: ${fmt(income)} ‚ÇΩ ¬∑ –†–∞—Å—Ö–æ–¥—ã: ${fmt(expense)} ‚ÇΩ ¬∑ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è: ${isFinite(savingsRate) ? savingsRate.toFixed(1) + '%' : '‚Äî'}</div>
        </div>
        <div class="text-end">
          ${days > 0 ? `<div class="small-muted">–ü–µ—Ä–∏–æ–¥: <strong>${days} –¥–Ω.</strong></div>` : ''}
          ${perDay > 0 ? `<div class="mt-1"><span class="badge bg-primary">–ú–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –≤ –¥–µ–Ω—å: ${fmt(perDay)} ‚ÇΩ</span></div>` : ''}
        </div>
      `;
        resultBody.appendChild(header);

        const listsRow = document.createElement('div');
        listsRow.className = 'row';
        listsRow.innerHTML = `
        <div class="col-12 col-md-6 mb-2">
          <div class="card border-0">
            <div class="card-body p-0">
              <h6 class="mb-2">–î–æ—Ö–æ–¥—ã</h6>
              <ul class="list-group list-group-flush" id="result-incomes"></ul>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="card border-0">
            <div class="card-body p-0">
              <h6 class="mb-2">–†–∞—Å—Ö–æ–¥—ã</h6>
              <ul class="list-group list-group-flush" id="result-expenses"></ul>
            </div>
          </div>
        </div>
      `;
        resultBody.appendChild(listsRow);

        const incomesList = resultBody.querySelector('#result-incomes');
        const expensesList = resultBody.querySelector('#result-expenses');

        if (incomes.length === 0) incomesList.innerHTML = `<li class="list-group-item small-muted">–ù–µ—Ç –¥–æ—Ö–æ–¥–æ–≤</li>`;
        else incomes.forEach(i => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<div class="text-truncate">${escapeHtml(i.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div><div class="ms-2"><strong>${fmt(i.value)} ‚ÇΩ</strong></div>`;
            incomesList.appendChild(li);
        });

        if (expenses.length === 0) expensesList.innerHTML = `<li class="list-group-item small-muted">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</li>`;
        else expenses.forEach(e => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<div class="text-truncate">${escapeHtml(e.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')} ${e.transferred ? '<span class="badge bg-info text-dark ms-1">–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ</span>' : ''}</div><div class="ms-2"><strong>${fmt(e.value)} ‚ÇΩ</strong></div>`;
            expensesList.appendChild(li);
        });

        const note = document.createElement('div');
        note.className = 'mt-3 small-muted';
        if (balance > 0) note.innerHTML = '‚úÖ –û—Ç–ª–∏—á–Ω–æ ‚Äî –µ—Å—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ–¥—É–º–∞–π –æ —Ü–µ–ª–∏: –¥–µ–ø–æ–∑–∏—Ç, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –∏–ª–∏ "–ø–æ–¥—É—à–∫–∞".';
        else if (balance === 0) note.innerHTML = 'üòê –ë–∞–ª–∞–Ω—Å –Ω—É–ª–µ–≤–æ–π ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å.';
        else note.innerHTML = `‚ö†Ô∏è –î–µ—Ñ–∏—Ü–∏—Ç ${fmt(Math.abs(balance))} ‚ÇΩ ‚Äî —Å–æ–∫—Ä–∞—Ç–∏ —Ä–∞—Å—Ö–æ–¥—ã –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥—ã.`;
        resultBody.appendChild(note);

        $('#result').classList.remove('d-none');
        saveData();
    }

    // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ ---
    function saveData() {
        const payload = {
            incomes: getItems('income-list'),
            expenses: getItems('expenses-list'),
            startDate: $('#start-date').value,
            endDate: $('#end-date').value
        };
        localStorage.setItem('financeData', JSON.stringify(payload));
    }

    function loadData() {
        const raw = localStorage.getItem('financeData');
        $('#income-list').innerHTML = '';
        $('#expenses-list').innerHTML = '';
        if (raw) {
            try {
                const data = JSON.parse(raw);
                (data.incomes || []).forEach(i => addInput('income-list', i.name, i.value));
                (data.expenses || []).forEach(e => addInput('expenses-list', e.name, e.value, e.transferred));
                if (data.startDate) $('#start-date').value = data.startDate;
                if (data.endDate) $('#end-date').value = data.endDate;
            } catch (e) {
                addInput('income-list');
                addInput('expenses-list');
            }
        } else {
            addInput('income-list');
            addInput('expenses-list');
        }
    }

    function escapeHtml(str) {
        return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadData();

        $('#addIncome').addEventListener('click', () => addInput('income-list'));
        $('#addExpense').addEventListener('click', () => addInput('expenses-list'));
        $('#calculateBtn').addEventListener('click', calculate);

        $('#start-date').addEventListener('change', saveData);
        $('#end-date').addEventListener('change', saveData);

        $('#clearAll').addEventListener('click', () => {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) {
                localStorage.removeItem('financeData');
                $('#income-list').innerHTML = '';
                $('#expenses-list').innerHTML = '';
                $('#start-date').value = '';
                $('#end-date').value = '';
                addInput('income-list');
                addInput('expenses-list');
                $('#result').classList.add('d-none');
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker?.register('sw.js').catch(()=>{});
        }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
